---
outline: deep
---

# Simulation

You can simulate the code generated by a [Source object](/en/concept/architecture#buildsource) using vif sim.

A simulation uses the ast produced by both your program and the provider to work.

vif-sim is a [WASM binary](https://webassembly.org/), so it runs on any web environments.

However, it is not [isomorphic](https://github.com/nodejs/undici/issues/2751), as different bundling is required for the browser and Node environments.

_It might change in a future release of Vif depending on how the WASM ecosystem evolves._

For now, you have to download either sim-node or sim-web depending on what environment you choose.

:::tip
All features and the syntax are the same in both packages.
:::

:::info
All simulation snippets of this documentation run with the browser version. 
:::

## Installing Manually

Depending on your environment:

### Browser

<a href="https://www.npmjs.com/package/@vifjs/sim-web" target="_blank" class="flex flex-row gap-2 w-max">
    <img crossorigin="anonymous" alt="NPM License" src="https://img.shields.io/npm/l/@vifjs/sim-web">
    <img crossorigin="anonymous" alt="NPM Version" src="https://img.shields.io/npm/v/@vifjs/sim-web">
</a>

```sh [npx]
npx @vifjs/sim-web
```

### Node

<a href="https://www.npmjs.com/package/@vifjs/sim-node" target="_blank" class="flex flex-row gap-2 w-max">
    <img crossorigin="anonymous" alt="NPM License" src="https://img.shields.io/npm/l/@vifjs/sim-node">
    <img crossorigin="anonymous" alt="NPM Version" src="https://img.shields.io/npm/v/@vifjs/sim-node">
</a>

```sh [npx]
npx @vifjs/sim-node
```

## About browser & Vite

### CORS

Both versions use [SharedArrayBuffer](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer) to communicate between multiple threads.

While it is not a problem on node, you'll need to create [specific headers](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer#security_requirements) if you plan to use the browser version.

There are tons of ways to create your own headers depending on the front end framework / bundler you choose.

However if you plan to use [vite](https://vitejs.dev/) , here's what you must add to your `vite.config.ts`

In the plugins section, configure the CORS headers:

```ts
plugins: [
    {
        name: "configure-response-headers",
        configureServer: (server) => {
            server.middlewares.use((_req, res, next) => {
                res.setHeader("Cross-Origin-Embedder-Policy", "require-corp");
                res.setHeader("Cross-Origin-Opener-Policy", "same-origin");
                next();
            });
        },
    },
]
```

There are plugins that do the exact same thing, but this solution seem to be enough (otherwise this documentation wouldn't even work).

### Wasm files

Next WASM files will probably be an issue.

You have 2 choices to fix this problem in vite:

#### Exclude

Tell vite not to bundle [vif-sim](/en/simulation/introduction) by putting it in `exclude` of `optimizeDeps`:

```ts
optimizeDeps: {
    exclude: [
        "@vifjs/sim-web"
    ]
}
```

While this fixes most of it when you are in dev mode, it will be a problem if you want to build an application.

The solution for this documentation was to add [Meta url plugin](https://www.npmjs.com/package/@chialab/esbuild-plugin-meta-url) for esbuild:

```ts
optimizeDeps: {
    esbuildOptions: {
        plugins: [
            metaUrlPlugin()
        ]
    }
}
```

#### Use vite-wasm-plugin

Another way to fix this problem is to use [vite-plugin-wasm](https://www.npmjs.com/package/vite-plugin-wasm).
